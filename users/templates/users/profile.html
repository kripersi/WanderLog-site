{% extends 'base.html' %}
{% block content %}
{% load static %}

<h2>Профиль пользователя</h2>

{% if is_owner %}
<form method="post" enctype="multipart/form-data" class="profile-form" id="profileForm">
    {% csrf_token %}
    {% endif %}

    <div class="profile-header">

        <div class="avatar-block">
            <div class="avatar">
                {% if profile_user.profile.avatar %}
                <img src="{{ profile_user.profile.avatar.url }}">
                {% else %}
                <img src="/static/images/default-avatar.jpg">
                {% endif %}
            </div>

            {% if is_owner %}
            <label for="id_avatar" class="avatar-btn">Изменить фото</label>
            {{ form.avatar }}
            {% endif %}
        </div>

        <div class="info">
            <label>Ник:</label>
            <p class="username">{{ profile_user.username }}</p>

            <label>Биография:</label>

            {% if is_owner %}
            {{ form.bio }}
            {% else %}
            <p>{{ profile_user.profile.bio }}</p>
            {% endif %}
        </div>
    </div>

    {% if is_owner %}
    <div class="profile-actions">
        <button type="submit"
                class="profile-btn"
                id="saveProfileBtn"
                disabled>
            Сохранить
        </button>

        <a href="{% url 'users:likes' %}"
           class="profile-btn">
            Лайки
        </a>
    </div>
</form>
{% endif %}

<hr>

<h3>Посты пользователя</h3>

<div class="feed">
    {% for post in posts %}
    <div class="feed-item">
        <div class="feed-image">
            {% if post.images.first %}
            <img src="{{ post.images.first.image.url }}">
            {% else %}
            <div class="no-image">Нет фото</div>
            {% endif %}
        </div>

        <div class="feed-content">
            <h2>
                <a href="{% url 'posts:post_detail' post.id %}">
                    {{ post.title }}
                </a>
            </h2>
            <p class="feed-text">
                {{ post.description|truncatewords:20 }}
            </p>
        </div>
        {% if request.user == post.author %}
        <form method="post" action="{% url 'posts:delete_post' post.pk %}" onsubmit="return confirmDelete();"
              style="margin-top:10px;">
            {% csrf_token %}
            <button type="submit" class="delete-btn">Удалить</button>
        </form>
        {% endif %}
    </div>
    <hr class="divider">
    {% empty %}
    <p>У пользователя пока нет постов.</p>
    {% endfor %}
</div>
<script>
    function confirmDelete() {
        return confirm("Вы уверены, что хотите удалить этот пост?");
    }
</script>
{% block scripts %}
<script src="{% static 'posts/js/photo_preview.js' %}"></script>
<script>
    (function () {
        const form = document.getElementById("profileForm");
        const saveBtn = document.getElementById("saveProfileBtn");
        if (!form || !saveBtn) {
            return;
        }

        const controls = form.querySelectorAll("input, textarea");
        const initial = {};
        controls.forEach((el) => {
            if (el.type === "file") {
                initial[el.name] = "";
            } else {
                initial[el.name] = el.value;
            }
        });

        function hasChanges() {
            let changed = false;
            controls.forEach((el) => {
                if (changed) {
                    return;
                }
                if (el.type === "file") {
                    if (el.files && el.files.length > 0) {
                        changed = true;
                    }
                } else if (el.value !== initial[el.name]) {
                    changed = true;
                }
            });
            return changed;
        }

        function updateState() {
            const changed = hasChanges();
            saveBtn.disabled = !changed;
            saveBtn.classList.toggle("is-disabled", !changed);
        }

        controls.forEach((el) => {
            el.addEventListener("input", updateState);
            el.addEventListener("change", updateState);
        });

        updateState();
    })();
</script>
{% endblock %}

{% endblock %}
